{% extends 'base.html' %}
{% block content %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div>
    <!-- Main image -->
    {% include "items/_main_image.html" with item=item %}

    <!-- Gallery (partial container) -->
    <div id="gallery"
         hx-get="{% url 'core:item_detail' item.pk %}?frag=gallery"
         hx-trigger="load"
         hx-target="#gallery"
         hx-swap="innerHTML">
      <!-- will be replaced by _gallery.html -->
      <div class="mt-2 text-sm text-gray-500">Galéria betöltése…</div>
    </div>

    {% if request.user == item.owner %}
      <!-- Image upload form (inline) -->
      <div id="image-form" class="mt-4">
        {% include "items/_image_form.html" with item=item form=img_form %}
      </div>
    {% endif %}
  </div>

  <div>
    <!-- Read-only block (swappable to edit form) -->
    <div id="item-info">
      {% include "items/_read_only.html" with item=item %}
    </div>

    {% if request.user.profile.verified %}
      {% if request.user.is_authenticated and request.user != item.owner %}
        {% if item.is_available %}
          <div class="mt-3">
            <form method="post" action="{% url 'core:loan_request' item.pk %}">
              {% csrf_token %}
              <button class="px-3 py-2 bg-emerald-600 text-white rounded">
                Kölcsönzés
              </button>
            </form>
          </div>
        {% else %}
          <div class="mt-3 text-sm text-red-600">Jelenleg ez a holmi nem kölcsönözhető.</div>
        {% endif %}
      {% endif %}
    {% else %}
      <div class="mt-3 text-sm text-red-600">Csak admin által visszaigazolt felhasználók kölcsönözhetnek.</div>
    {% endif %}


    {% if request.user == item.owner %}
      <div class="mt-3">
        <button
          class="px-3 py-2 bg-gray-900 text-white rounded"
          hx-get="{% url 'core:item_detail' item.pk %}?frag=edit"
          hx-target="#item-info"
          hx-swap="outerHTML">
          Szerkesztés
        </button>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // thumbnail click -> swap main image
    function selectImage(el) {
      const main = document.getElementById("main-image");
      if (main) main.src = el.dataset.fullsrc || el.src;
      document.querySelectorAll(".thumb").forEach(e => e.classList.remove("ring-4","ring-black"));
      el.classList.add("ring-4","ring-black");
  }
</script>
{% endblock %}
